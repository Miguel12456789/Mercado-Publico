<!DOCTYPE html>
<html lang="pt-pt">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Notificação</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="tab_mp.css">
</head>

<body>
  <div class="overlay" id="overlay">
    <div class="popup">
      <button class="close-btn" id="closeBtn">&times;</button>
      <h2 class="popup-title">Formulário de Download</h2>

      <!-- Onde o formulário do HubSpot será inserido -->
      <div id="meu-form"></div>

      <!-- Campo de verificação (inicialmente escondido) -->
      <div id="codigo-verificacao" style="display:none; margin-top:20px;">
        <label>Digite o código que enviámos por email:</label>
        <input type="text" id="inputCodigo" placeholder="Ex: 123456" />
        <button id="btnVerificar">Verificar Código</button>
      </div>

      <!-- Script do HubSpot -->
      <script charset="utf-8" src="https://js-eu1.hsforms.net/forms/v2.js"></script>

      <script>
        // Cria o formulário HubSpot
        hbspt.forms.create({
          region: "eu1",
          portalId: "139646329",
          formId: "1eb1ed6d-1f1b-4c3c-aef6-44c3c31499a3",
          target: "#meu-form",
          onFormReady: function ($form) {
            console.log("✅ Formulário carregado!");

            // Intercepta o envio do formulário original do HubSpot
            $form.on('submit', function (e) {
              e.preventDefault(); // impede o envio para o HubSpot

              // Obtém os valores dos campos
              const email = $form.find('input[name="email"]').val();
              const nome = $form.find('input[name="firstname"]').val();

              if (!email) {
                alert("Por favor, preencha o email.");
                return;
              }

              // Envia dados para o backend gerar e enviar o código
              fetch("/sendEmail", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ email, nome })
              })
                .then(res => res.json())
                .then(data => {
                  if (data.ok) {
                    alert("Enviámos um código de verificação para o seu email!");
                    document.getElementById("codigo-verificacao").style.display = "block";
                    // guarda dados temporariamente
                    window._lead = { email, nome };
                  } else {
                    alert("Erro ao enviar o código. Tente novamente.");
                  }
                })
                .catch(err => {
                  console.error(err);
                  alert("Erro no servidor.");
                });
            });
          }
        });

        // Quando o utilizador clica em "Verificar Código"
        document.addEventListener("click", async (e) => {
          if (e.target.id === "btnVerificar") {
            const codigo = document.getElementById("inputCodigo").value.trim();
            const lead = window._lead;
            if (!codigo) return alert("Digite o código recebido.");
            if (!lead) return alert("Formulário não preenchido ainda.");

            const res = await fetch("/verify_code", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ email: lead.email, codigo })
            });
            const data = await res.json();

            if (data.valido) {
              alert("Código verificado! Enviando seus dados...");

              // Envia os dados para o HubSpot via API do teu backend
              fetch("/sendHubSpot", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(lead)
              })
                .then(r => r.json())
                .then(r => {
                  if (r.sucesso) {
                    alert("Formulário concluído com sucesso!");
                    document.getElementById("codigo-verificacao").style.display = "none";
                  } else {
                    alert("Erro ao enviar para o HubSpot.");
                  }
                });

            } else {
              alert("Código incorreto. Verifique e tente novamente.");
            }
          }
        });
      </script>
    </div>
  </div>
</body>
</html>
