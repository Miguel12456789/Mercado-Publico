<link rel="stylesheet" href="paginacao.css">

<div class="pagination-container">
    <div class="pagination-info">
        <span id="showing-entries">
            Mostrando <%= pagination.startIndex %>-<%= pagination.endIndex %> de <%= pagination.totalContracts %>
                        registros
        </span>
    </div>
    <div class="pagination-controls">
        <div class="items-per-page">
            <label for="items-select">Contratos por p√°gina:</label>
            <select id="items-select" class="items-select">
                <option value="25" <%=pagination.limit===25 ? 'selected' : '' %>>25</option>
                <option value="50" <%=pagination.limit===50 ? 'selected' : '' %>>50</option>
                <option value="100" <%=pagination.limit===100 ? 'selected' : '' %>>100</option>
            </select>
        </div>
        <div class="page-navigation">
            <button id="prev-page" class="page-button" <%=!pagination.hasPrevPage ? 'disabled' : '' %> data-page="<%=
                    pagination.currentPage - 1 %>">
                    <i data-lucide="chevron-left" class="page-icon"></i>
            </button>
            <div id="page-numbers" class="page-numbers">
                <% for (let i=Math.max(1, pagination.currentPage - 2); i <=Math.min(pagination.totalPages,
                    pagination.currentPage + 2); i++) { %>
                    <button class="page-number <%= i === pagination.currentPage ? 'active' : '' %>"
                        data-page="<%= i %>">
                        <%= i %>
                    </button>
                    <% } %>
            </div>
            <button id="next-page" class="page-button" <%=!pagination.hasNextPage ? 'disabled' : '' %> data-page="<%=
                    pagination.currentPage + 1 %>">
                    <i data-lucide="chevron-right" class="page-icon"></i>
            </button>
        </div>
    </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const itemsSelect = document.getElementById('items-select');
        const pageNumbers = document.getElementById('page-numbers');
        const prevPageBtn = document.getElementById('prev-page');
        const nextPageBtn = document.getElementById('next-page');
        const showingEntries = document.getElementById('showing-entries');

        // üî∏ Guarda filtros atuais
        let currentFilters = {};

        // üî∏ Submit do formul√°rio
        document.querySelector('form[action="/base_gov"]').addEventListener('submit', e => {
            e.preventDefault();

            const form = e.currentTarget;
            const formData = new FormData(form);
            const limit = itemsSelect.value;

            currentFilters = {};
            formData.forEach((value, key) => {
                currentFilters[key] = value;
            });

            loadContracts(1, limit);
        });

        // üî∏ Carrega contratos com filtros ativos
        const loadContracts = (page = 1, limit = itemsSelect.value) => {
            window.loadContracts = loadContracts;
            const url = new URL('/base_gov', window.location.origin);
            url.searchParams.set('page', page);
            url.searchParams.set('limit', limit);

            for (const [key, value] of Object.entries(currentFilters)) {
                url.searchParams.set(key, value);
            }

            fetch(url, { headers: { 'Accept': 'application/json' } })
                .then(res => res.json())
                .then(({ contracts, pagination }) => {
                    updateTable(contracts);
                    updatePagination(pagination);
                })
                .catch(err => console.error('Erro ao carregar contratos:', err));
        };

        const updateTable = (contracts) => {
            const tbody = document.querySelector('.results-table tbody');
            tbody.innerHTML = '';

            if (!contracts.length) {
                tbody.innerHTML = `<tr><td colspan="7" class="no-results">Nenhum contrato encontrado.</td></tr>`;
                return;
            }

            const rowsHtml = contracts.map(contract => `
                <tr>
                    <td>${contract.tipoContrato ?? 'N/A'}</td>
                    <td>${contract.tipoprocedimento ?? 'N/A'}</td>
                    <td>${(contract.adjudicante ?? 'N/A').replace(/^\d+\s*-\s*/, '')}</td>
                    <td>${(contract.adjudicatarios ?? 'N/A').replace(/^\d+\s*-\s*/, '')}</td>
                    <td>${contract.precoContratual ? formatPrice(contract.precoContratual) : 'N/A'}</td>
                    <td>${contract.dataPublicacao ?? 'N/A'}</td>
                    <td><button class="details-button" aria-label="Ver detalhes" data-contract-id="${contract._id}">
                        <i class="fas fa-plus-circle"></i></button></td>
                </tr>
            `).join('');

            tbody.innerHTML = rowsHtml;
            bindDetailButtons();
        };

        const updatePagination = ({ currentPage, totalPages, limit, startIndex, endIndex, totalContracts, hasPrevPage, hasNextPage }) => {
            showingEntries.textContent = `Mostrando ${startIndex}-${endIndex} de ${totalContracts} registros`;
            itemsSelect.value = limit;
            pageNumbers.innerHTML = '';

            const createPageButton = (page) => {
                const btn = document.createElement('button');
                btn.className = `page-number ${page === currentPage ? 'active' : ''}`;
                btn.dataset.page = page;
                btn.textContent = page;
                btn.addEventListener('click', () => loadContracts(page, limit));
                return btn;
            };

            for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) {
                pageNumbers.appendChild(createPageButton(i));
            }

            prevPageBtn.disabled = !hasPrevPage;
            nextPageBtn.disabled = !hasNextPage;

            prevPageBtn.onclick = hasPrevPage ? () => loadContracts(currentPage - 1, limit) : null;
            nextPageBtn.onclick = hasNextPage ? () => loadContracts(currentPage + 1, limit) : null;

            if (typeof lucide !== 'undefined') lucide.createIcons();
        };

        const formatPrice = (price) => {
            const numericPrice = Number(String(price).trim());
            if (isNaN(numericPrice)) return 'N/A';
            const parts = numericPrice.toFixed(2).split('.');
            parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, '.');
            return `${parts[0]},${parts[1]} ‚Ç¨`;
        };

        const bindDetailButtons = () => {
            document.querySelectorAll('.details-button').forEach(button => {
                button.addEventListener('click', () => {
                    const id = button.getAttribute('data-contract-id');
                    if (id) window.location.href = `/detalhescontrato/${id}`;
                });
            });
        };

        // üî∏ Troca de itens por p√°gina
        itemsSelect.addEventListener('change', () => {
            loadContracts(1, itemsSelect.value);
        });

        // üî∏ Inicializa (carrega tudo sem filtros se n√£o houver formul√°rio)
        const searchForm = document.querySelector('form[action="/base_gov"]');
        if (!searchForm) loadContracts();
    });
</script>