<!DOCTYPE html>
<html lang="pt-pt">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/base_gov.css">
    <!-- Include Lucide icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <title>Helpdesk P√∫blico</title>
</head>

<body>

    <main class="container py-8">
        <h1 class="titulo">Estat√≠sticas Mercado P√∫blico</h1>
        <div class="banner">
            <p>
                Bem-vindos √† p√°gina de estat√≠sticas do Helpdesk P√∫blico. <br>
                Aqui encontra toda a informa√ß√£o p√∫blica sobre os Contratos de Compras P√∫blicas. <br>
                Consulte todas as informa√ß√µes sobre os Contratos P√∫blicos de forma mais √°gil e pr√°tica. <br>

            </p>
        </div>

        <div class="info-box">
            <p>Nos campos de sele√ß√£o dispon√≠veis deve selecionar as op√ß√µes pretendidas para realizar a sua pesquisa,
                quanto maior for a sele√ß√£o de campos mais reduzida ser√° a lista de resultados.</p>
            <p>Pode realizar qualquer tipo de sele√ß√£o, seja um objeto ou um espa√ßo temporal, ou os dois.

                Caso n√£o encontre o resultado desejado, reinicie a p√°gina e se poss√≠vel elimine os cookies.

                Caso tenha dificuldade e necessite de suporte, regresse √† p√°gina inicial das estat√≠sticas e procure
                suporte na janela do chat ou atrav√©s dos contactos disponibilizados no nosso website.</p>
        </div>
        </div>

        <form action="/base_gov" method="get">
            <div class="search-container">
                <div class="search-row">
                    <input type="text" name="search" placeholder="Pesquisar pelo objeto do Contrato"
                        class="search-input" />
                </div>

                <!-- Advanced Search Form -->
                <div id="advanced-search-form" class="advanced-search-form">
                    <div class="form-content">
                        <!-- First Row -->
                        <div class="form-row">
                            <div class="form-group">
                                <input type="checkbox" id="special-measures" name="special-measures"
                                    class="form-checkbox" />
                                <div class="tooltip-container">
                                    <label for="special-measures" class="form-label">
                                        Medidas especiais
                                    </label>
                                    <i data-lucide="info" class="info-icon"></i>
                                    <div class="tooltip">
                                        Medidas especiais aplic√°veis aos contratos p√∫blicos de acordo com a Lei n.¬∫
                                        30/2021, de 21 de maio.
                                        Inclui medidas para projetos financiados por fundos europeus, habita√ß√£o,
                                        tecnologias de informa√ß√£o,
                                        sa√∫de e outros setores espec√≠ficos.
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <input type="checkbox" id="include-mec" name="include-mec" class="form-checkbox" />
                                <div class="tooltip-container">
                                    <label for="include-mec" class="form-label">
                                        Incluir MEC ao abrigo do CCP
                                    </label>
                                    <i data-lucide="info" class="info-icon"></i>
                                    <div class="tooltip">
                                        Assinale para pesquisar procedimentos lan√ßados ao abrigo do CCP com uma
                                        tipologia das medidas especiais
                                    </div>
                                </div>
                            </div>

                            <div class="form-field">
                                <div class="tooltip-container">
                                    <label for="measure-type" class="form-label">
                                        Tipologia da medida especial
                                    </label>
                                    <i data-lucide="info" class="info-icon"></i>
                                    <div class="tooltip">
                                        Para escolher a tipologia das medidas especiais assinale pelo menos uma das
                                        caixas anteriores
                                    </div>
                                </div>
                                <select id="measure-type" name="measure-type" class="form-select" disabled>
                                    <option>Todos</option>
                                    <option>Projetos financiados ou cofinanciados por fundos europeus - artigo 2¬∫ da Lei
                                        n.¬∫ 30/2021</option>
                                    <option>Habita√ß√£o e descentraliza√ß√£o - artigo 3¬∫ da Lei n.¬∫ 30/2021</option>
                                    <option>Tecnologias de informa√ß√£o e conhecimento - artigo 4¬∫ da Lei n.¬∫ 30/2021
                                    </option>
                                    <option>Setor da sa√∫de e do apoio social - artigo 5¬∫ da Lei n.¬∫ 30/2021</option>
                                    <option>Plano de Recupera√ß√£o e Resili√™ncia (PRR) - artigo 2¬∫ da Lei n.¬∫ 30/2021, DL
                                        n.¬∫ 78/2022</option>
                                    <option>Sistema de Gest√£o Integrada de Fogos Rurais - artigo 7¬∫ da Lei n.¬∫ 30/2021
                                    </option>
                                    <option>Bens agro-alimentares - artigo 8¬∫ da Lei n.¬∫ 30/2021</option>
                                    <option>Programa de Estabiliza√ß√£o Econ√≥mica e Social (PEES) - artigo 6¬∫ da Lei n.¬∫
                                        30/2021</option>
                                    <option>Plano de Recupera√ß√£o e Resili√™ncia (PRR) - artigo 6¬∫ da Lei n.¬∫ 30/2021
                                    </option>
                                    <option>Regime especial de empreitadas de conce√ß√£o-constru√ß√£o - artigo 2¬∫-A da Lei
                                        n.¬∫ 30/2021, DL n.¬∫ 78/2022</option>
                                </select>
                            </div>
                        </div>

                        <hr class="form-divider" />

                        <!-- Second Row -->
                        <div class="form-row">
                            <div class="form-field">
                                <label for="procedure-type" class="form-label">
                                    Tipo de Procedimento
                                </label>
                                <select id="procedure-type" name="tipoProcedimento" class="form-select">
                                    <option value="0">Todos</option>
                                    <option value="8">Consulta Pr√©via</option>
                                    <option value="1">Ajuste Direto Regime Geral</option>
                                    <option value="2">Concurso p√∫blico</option>
                                    <option value="3">Concurso limitado por pr√©via qualifica√ß√£o</option>
                                    <option value="4">Procedimento de negocia√ß√£o</option>
                                    <option value="5">Di√°logo concorrencial</option>
                                    <option value="6">Ao abrigo de acordo-quadro (art.¬∫ 258.¬∫)</option>
                                    <option value="7">Ao abrigo de acordo-quadro (art.¬∫ 259.¬∫)</option>
                                    <option value="9">Parceria para a inova√ß√£o</option>
                                    <option value="10">Disponibiliza√ß√£o de bens m√≥veis</option>
                                    <option value="11">Servi√ßos sociais e outros servi√ßos espec√≠ficos</option>
                                    <option value="13">Concurso de conce√ß√£o simplificado</option>
                                    <option value="14">Concurso de ideias simplificado</option>
                                    <option value="15">Consulta Pr√©via Simplificada</option>
                                    <option value="16">Concurso p√∫blico simplificado</option>
                                    <option value="17">Concurso limitado por pr√©via qualifica√ß√£o simplificado</option>
                                    <option value="18">Ajuste Direto Regime Geral ao abrigo do artigo 7¬∫ da Lei n.¬∫
                                        30/2021, de 21.05</option>
                                    <option value="19">Consulta pr√©via ao abrigo do artigo 7¬∫ da Lei n.¬∫ 30/2021, de
                                        21.05</option>
                                    <option value="20">Ajuste direto simplificado</option>
                                    <option value="21">Ajuste direto simplificado ao abrigo da Lei n.¬∫ 30/2021, de 21.05
                                    </option>
                                    <option value="22">Setores especiais - isen√ß√£o parte II</option>
                                    <option value="23">Contrata√ß√£o exclu√≠da II</option>
                                </select>
                            </div>

                            <div class="form-field">
                                <div class="tooltip-container">
                                    <label for="entity" class="form-label">
                                        Entidade Adjudicante
                                    </label>
                                    <i data-lucide="info" class="info-icon"></i>
                                    <div class="tooltip">
                                        Pode pesquisar pelo NIPC ou descri√ß√£o da entidade
                                    </div>
                                </div>
                                <input type="text" name="entidade" id="entity" class="form-input" />
                            </div>
                        </div>

                        <!-- Third Row -->
                        <div class="form-row">
                            <div class="form-field">
                                <label for="contract-type" class="form-label">
                                    Tipo de Contrato
                                </label>
                                <select id="contract-type" name="tipoContrato" class="form-select">
                                    <option value="0">Todos</option>
                                    <option value="1">Aquisi√ß√£o de bens m√≥veis</option>
                                    <option value="2">Aquisi√ß√£o de servi√ßos</option>
                                    <option value="3">Concess√£o de obras p√∫blicas</option>
                                    <option value="4">Concess√£o de servi√ßos p√∫blicos</option>
                                    <option value="5">Empreitadas de obras p√∫blicas</option>
                                    <option value="6">Loca√ß√£o de bens m√≥veis</option>
                                    <option value="7">Sociedade</option>
                                    <option value="8">Outros</option>
                                </select>
                            </div>

                            <div class="form-field">
                                <div class="tooltip-container">
                                    <label for="awarded-entity" class="form-label">
                                        Entidade Adjudicat√°ria
                                    </label>
                                    <i data-lucide="info" class="info-icon"></i>
                                    <div class="tooltip">
                                        Pode pesquisar pelo NIPC ou descri√ß√£o da entidade
                                    </div>
                                </div>
                                <input type="text" id="awarded-entity" name="adjudicatario" class="form-input" />
                            </div>
                        </div>

                        <!-- Fourth Row -->
                        <div class="form-row">
                            <div class="form-field">
                                <div class="tooltip-container">
                                    <label for="cpv" class="form-label">
                                        CPV
                                    </label>
                                    <i data-lucide="info" class="info-icon"></i>
                                    <div class="tooltip">
                                        Pode pesquisar pelo c√≥digo ou descri√ß√£o do Vocabul√°rio Comum para os Contratos
                                        P√∫blicos"
                                    </div>
                                </div>
                                <input type="text" name="cpv" id="cpv" class="form-input" />
                            </div>

                            <div class="form-group">
                                <input type="hidden" name="environmental-criteria" value="off" />
                                <input type="checkbox" id="environmental-criteria" name="environmental-criteria"
                                    class="form-checkbox" value="on" />

                                <label for="environmental-criteria" class="form-label">
                                    Crit√©rios ambientais
                                </label>
                            </div>

                        </div>

                        <!-- Fifth Row - Dates and Location -->
                        <div class="form-row">
                            <div class="form-field date-container">
                                <div class="tooltip-container">
                                    <label for="date-type" class="form-label">
                                        Datas
                                    </label>
                                    <i data-lucide="info" class="info-icon"></i>
                                    <div class="tooltip">
                                        Pode pesquisar em simult√¢neo pelos v√°rios intervalos de datas
                                    </div>
                                </div>
                                <select id="date-type" name="date-type" class="form-select">
                                    <option value="0">Data de Publica√ß√£o</option>
                                    <option value="1">Data do Contrato</option>
                                    <option value="2">Data de Fecho</option>
                                </select>

                                <div class="date-range">
                                    <div class="date-field">
                                        <label for="date-from" class="form-label">De:</label>
                                        <div class="date-selects">
                                            <select id="from-year" name="from-year" class="date-select"></select>
                                            <select id="from-month" name="from-month" class="date-select"></select>
                                            <select id="from-day" name="from-day" class="date-select"></select>
                                        </div>
                                    </div>

                                    <div class="date-field">
                                        <label for="date-to" class="form-label">At√©:</label>
                                        <div class="date-selects">
                                            <select id="to-year" name="to-year" class="date-select"></select>
                                            <select id="to-month" name="to-month" class="date-select"></select>
                                            <select id="to-day" name="to-day" class="date-select"></select>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="form-field location-container">
                                <label class="form-label">
                                    Local de Execu√ß√£o (Pa√≠s, Distrito, Concelho)
                                </label>
                                <select id="pais-select" name="pais" class="form-select location-select">
                                    <option>Todos</option>
                                    <option value="portugal">Portugal</option>
                                    <option value="espanha">Outro</option>
                                </select>
                                </select>
                                <select id="distrito-select" name="distrito" class="form-select location-select"
                                    disabled>
                                    <option value="">Todos os distrito</option>
                                    <option value="aveiro">Aveiro</option>
                                    <option value="beja">Beja</option>
                                    <option value="braga">Braga</option>
                                    <option value="braganca">Bragan√ßa</option>
                                    <option value="castelo_branco">Castelo Branco</option>
                                    <option value="coimbra">Coimbra</option>
                                    <option value="evora">√âvora</option>
                                    <option value="faro">Faro</option>
                                    <option value="guarda">Guarda</option>
                                    <option value="leiria">Leiria</option>
                                    <option value="lisboa">Lisboa</option>
                                    <option value="portalegre">Portalegre</option>
                                    <option value="porto">Porto</option>
                                    <option value="santarem">Santar√©m</option>
                                    <option value="setubal">Set√∫bal</option>
                                    <option value="viana_do_castelo">Viana do Castelo</option>
                                    <option value="vila_real">Vila Real</option>
                                    <option value="viseu">Viseu</option>
                                </select>
                                <select id="concelho-select" name="concelho" class="form-select location-select"
                                    disabled>
                                    <option value="">Todos os concelhos</option>
                                    <!-- Ser√° preenchido dinamicamente com JavaScript -->
                                </select>
                            </div>
                        </div>

                        <!-- Form Buttons -->
                        <div class="form-buttons">
                            <button id="clear-form-btn" class="clear-button">
                                <i data-lucide="x" class="icon-small"></i>
                                <span>LIMPAR</span>
                            </button>
                            <button type="submit" id="search-contracts-button" class="submit-button">
                                <i data-lucide="search" class="icon-small"></i>
                                <span>PESQUISAR</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </main>


    <div class="custom-notif__container" id="notificacao-container" style="display: none;">
        <div class="custom-notif__wrapper">
            <div class="custom-notif__content">
                <div class="custom-notif__icon">
                    <i class="fas fa-envelope"></i>
                </div>
                <div class="custom-notif__text">
                    Deseja fazer download desta informa√ß√£o?
                    <a class="custom-notif__link" id="openPopupBtn">Clique aqui</a> e ap√≥s inserir os seus dados
                    iniciar-se-√° o download.
                </div>
            </div>
            <button class="custom-notif__close"
                onclick="document.getElementById('notificacao-container').style.display='none'">
                &times;
            </button>
        </div>
    </div>

    <% if (typeof contracts !=='undefined' ) { %>
        <%- include('components/tab_base', {contracts: contracts}) %>
            <% } else { %>
                <div class="no-contracts">
                    <p>Nenhum dado de contrato dispon√≠vel no momento.</p>
                </div>
                <% } %>

                    <%- include('components/mail_receive') %>
                        <%- include('components/button') %>

                            <script>
                                document.addEventListener('DOMContentLoaded', () => {
                                    console.log('DOM carregado');

                                    // ========== Utils ==========
                                    const qs = (s, p = document) => p.querySelector(s);
                                    const qsa = (s, p = document) => [...p.querySelectorAll(s)];

                                    // ========== Preencher selects de data ==========
                                    function populateDateSelectors(yearId, monthId, dayId) {
                                        const yearSelect = document.getElementById(yearId);
                                        const monthSelect = document.getElementById(monthId);
                                        const daySelect = document.getElementById(dayId);

                                        const currentYear = new Date().getFullYear();

                                        // Placeholders
                                        yearSelect.innerHTML = '<option disabled selected>Ano:</option>';
                                        monthSelect.innerHTML = '<option disabled selected>M√™s:</option>';
                                        daySelect.innerHTML = '<option disabled selected>Dia:</option>';

                                        // Preencher anos (do ano atual at√© 1900)
                                        for (let y = currentYear; y >= 1900; y--) {
                                            yearSelect.innerHTML += `<option value="${y}">${y}</option>`;
                                        }

                                        // Preencher meses (01 a 12)
                                        for (let m = 1; m <= 12; m++) {
                                            const paddedMonth = m.toString().padStart(2, '0');
                                            monthSelect.innerHTML += `<option value="${m}">${paddedMonth}</option>`;
                                        }

                                        // Atualizar dias com base no m√™s e ano selecionados
                                        function updateDays() {
                                            const year = parseInt(yearSelect.value);
                                            const month = parseInt(monthSelect.value);

                                            if (!year || !month) return;

                                            const daysInMonth = new Date(year, month, 0).getDate();
                                            daySelect.innerHTML = '<option disabled selected>Dia:</option>';

                                            for (let d = 1; d <= daysInMonth; d++) {
                                                const paddedDay = d.toString().padStart(2, '0');
                                                daySelect.innerHTML += `<option value="${d}">${paddedDay}</option>`;
                                            }
                                        }

                                        yearSelect.addEventListener('change', updateDays);
                                        monthSelect.addEventListener('change', updateDays);

                                        yearSelect.selectedIndex = 0;
                                        monthSelect.selectedIndex = 0;
                                        daySelect.selectedIndex = 0;
                                    }

                                    populateDateSelectors('from-year', 'from-month', 'from-day');
                                    populateDateSelectors('to-year', 'to-month', 'to-day');


                                    // ========== √çcones Lucide ==========
                                    (typeof lucide === 'undefined' ? { createIcons: () => { } } : lucide).createIcons();

                                    // ========== Limpar formul√°rio ==========
                                    document.querySelector('#clear-form-btn')?.addEventListener('click', (e) => {
                                        e.preventDefault(); // Impede o submit
                                        const form = document.querySelector('form[action="/base_gov"]');
                                        if (!form) return;

                                        form.reset(); // Limpa todos os campos automaticamente

                                        // Para selects com value="0" ou "Todos"
                                        form.querySelectorAll('select').forEach(select => {
                                            select.selectedIndex = 0;
                                        });

                                        // Para os selects dependentes (desabilita)
                                        const measureTypeSelect = document.getElementById('measure-type');
                                        if (measureTypeSelect) measureTypeSelect.disabled = true;

                                        const distritoSelect = document.getElementById('distrito-select');
                                        if (distritoSelect) distritoSelect.disabled = true;

                                        const concelhoSelect = document.getElementById('concelho-select');
                                        if (concelhoSelect) concelhoSelect.disabled = true;
                                    });

                                    // ========== Mostrar resultados ==========
                                    const resultsTable = qs('#results-table');
                                    const notifContainer = qs('#notificacao-container');
                                    qsa('.search-button, .submit-button').forEach(btn =>
                                        btn.addEventListener('click', () => {
                                            resultsTable?.style.setProperty('display', 'block');
                                            notifContainer?.style.setProperty('display', 'block'); // Mostra a notifica√ß√£o s√≥ ap√≥s pesquisa
                                            resultsTable?.scrollIntoView({ behavior: 'smooth' });
                                        })
                                    )

                                    // Refer√™ncias aos elementos(faz bloquear e desbloquear as dropdowns se ela for selecionada)
                                    const checkboxes = [
                                        document.getElementById('special-measures'),
                                        document.getElementById('include-mec')
                                    ];
                                    const measureTypeSelect = document.getElementById('measure-type');
                                    // Fun√ß√£o para atualizar o estado do dropdown
                                    const updateDropdownState = () => {
                                        measureTypeSelect.disabled = !checkboxes.some(cb => cb.checked);
                                    };
                                    // Adicionar evento a todos os checkboxes
                                    checkboxes.forEach(cb => cb.addEventListener('change', updateDropdownState));
                                    // Estado inicial
                                    updateDropdownState();

                                    // ========== Listar os Conselhos ==========
                                    // Refer√™ncias aos elementos
                                    const paisSelect = document.getElementById('pais-select');
                                    const distritoSelect = document.getElementById('distrito-select');
                                    const concelhoSelect = document.getElementById('concelho-select');
                                    const distritosConcelhos = {
                                        aveiro: ["√Ågueda", "Albergaria-a-Velha", "Anadia", "Arouca", "Aveiro", "Castelo de Paiva", "Espinho", "Estarreja", "√çlhavo", "Mealhada", "Murtosa", "Oliveira de Azem√©is", "Oliveira do Bairro", "Ovar", "Santa Maria da Feira", "S√£o Jo√£o da Madeira", "Sever do Vouga", "Vagos", "Vale de Cambra"],
                                        beja: ["Aljustrel", "Almod√¥var", "Alvito", "Barrancos", "Beja", "Castro Verde", "Cuba", "Ferreira do Alentejo", "M√©rtola", "Moura", "Odemira", "Ourique", "Serpa", "Vidigueira"],
                                        braga: ["Amares", "Barcelos", "Braga", "Cabeceiras de Basto", "Celorico de Basto", "Esposende", "Fafe", "Guimar√£es", "P√≥voa de Lanhoso", "Terras de Bouro", "Vieira do Minho", "Vila Nova de Famalic√£o", "Vila Verde", "Vizela"],
                                        braganca: ["Alf√¢ndega da F√©", "Bragan√ßa", "Carrazeda de Ansi√£es", "Freixo de Espada √† Cinta", "Macedo de Cavaleiros", "Miranda do Douro", "Mirandela", "Mogadouro", "Torre de Moncorvo", "Vila Flor", "Vimioso", "Vinhais"],
                                        castelo_branco: ["Belmonte", "Castelo Branco", "Covilh√£", "Fund√£o", "Idanha-a-Nova", "Oleiros", "Penamacor", "Proen√ßa-a-Nova", "Sert√£", "Vila de Rei", "Vila Velha de R√≥d√£o"],
                                        coimbra: ["Arganil", "Cantanhede", "Coimbra", "Condeixa-a-Nova", "Figueira da Foz", "G√≥is", "Lous√£", "Mira", "Miranda do Corvo", "Montemor-o-Velho", "Oliveira do Hospital", "Pampilhosa da Serra", "Penacova", "Penela", "Soure", "T√°bua", "Vila Nova de Poiares"],
                                        evora: ["Alandroal", "Arraiolos", "Borba", "Estremoz", "√âvora", "Montemor-o-Novo", "Mora", "Mour√£o", "Portel", "Redondo", "Reguengos de Monsaraz", "Vendas Novas", "Viana do Alentejo", "Vila Vi√ßosa"],
                                        faro: ["Albufeira", "Alcoutim", "Aljezur", "Castro Marim", "Faro", "Lagoa", "Lagos", "Loul√©", "Monchique", "Olh√£o", "Portim√£o", "S√£o Br√°s de Alportel", "Silves", "Tavira", "Vila do Bispo", "Vila Real de Santo Ant√≥nio"],
                                        guarda: ["Aguiar da Beira", "Almeida", "Celorico da Beira", "Figueira de Castelo Rodrigo", "Fornos de Algodres", "Gouveia", "Guarda", "Manteigas", "M√™da", "Pinhel", "Sabugal", "Seia", "Trancoso", "Vila Nova de Foz C√¥a"],
                                        leiria: ["Alcoba√ßa", "Alvai√°zere", "Ansi√£o", "Batalha", "Bombarral", "Caldas da Rainha", "Castanheira de P√™ra", "Figueir√≥ dos Vinhos", "Leiria", "Marinha Grande", "Nazar√©", "√ìbidos", "Pedr√≥g√£o Grande", "Peniche", "Pombal", "Porto de M√≥s"],
                                        lisboa: ["Alenquer", "Amadora", "Arruda dos Vinhos", "Azambuja", "Cadaval", "Cascais", "Lisboa", "Loures", "Lourinh√£", "Mafra", "Odivelas", "Oeiras", "Sintra", "Sobral de Monte Agra√ßo", "Torres Vedras", "Vila Franca de Xira"],
                                        portalegre: ["Alter do Ch√£o", "Arronches", "Avis", "Campo Maior", "Castelo de Vide", "Crato", "Elvas", "Fronteira", "Gavi√£o", "Marv√£o", "Monforte", "Nisa", "Ponte de Sor", "Portalegre", "Sousel"],
                                        porto: ["Amarante", "Bai√£o", "Felgueiras", "Gondomar", "Lousada", "Maia", "Marco de Canaveses", "Matosinhos", "Pa√ßos de Ferreira", "Paredes", "Penafiel", "Porto", "P√≥voa de Varzim", "Santo Tirso", "S√£o Jo√£o da Madeira", "Trofa", "Valongo", "Vila do Conde", "Vila Nova de Gaia"],
                                        santarem: ["Abrantes", "Alcanena", "Almeirim", "Alpiar√ßa", "Benavente", "Cartaxo", "Chamusca", "Const√¢ncia", "Coruche", "Entroncamento", "Ferreira do Z√™zere", "Goleg√£", "Ma√ß√£o", "Our√©m", "Rio Maior", "Salvaterra de Magos", "Santar√©m", "Sardoal", "Tomar", "Torres Novas", "Vila Nova da Barquinha"],
                                        setubal: ["Alc√°cer do Sal", "Almada", "Barreiro", "Gr√¢ndola", "Moita", "Montijo", "Palmela", "Santiago do Cac√©m", "Seixal", "Sesimbra", "Set√∫bal", "Sines"],
                                        viana_do_castelo: ["Arcos de Valdevez", "Caminha", "Melga√ßo", "Mon√ß√£o", "Paredes de Coura", "Ponte da Barca", "Ponte de Lima", "Valen√ßa", "Viana do Castelo", "Vila Nova de Cerveira"],
                                        vila_real: ["Alij√≥", "Boticas", "Chaves", "Mes√£o Frio", "Mondim de Basto", "Montalegre", "Mur√ßa", "Peso da R√©gua", "Ribeira de Pena", "Sabrosa", "Santa Marta de Penagui√£o", "Valpa√ßos", "Vila Pouca de Aguiar", "Vila Real"],
                                        viseu: ["Armamar", "Carregal do Sal", "Castro Daire", "Cinf√£es", "Lamego", "Mangualde", "Moimenta da Beira", "Mort√°gua", "Nelas", "Oliveira de Frades", "Penalva do Castelo", "Penedono", "Resende", "Santa Comba D√£o", "S√£o Jo√£o da Pesqueira", "S√£o Pedro do Sul", "S√°t√£o", "Sernancelhe", "Tabua√ßo", "Tarouca", "Tondela", "Vila Nova de Paiva", "Viseu", "Vouzela"]
                                    };
                                    // Utilit√°rio para ativar/desativar <select>
                                    const setDisabled = (select, disabled) => {
                                        select.disabled = disabled;
                                        if (disabled) select.value = "";
                                    };

                                    // Atualiza o estado dos selects de distrito e concelho com base no pa√≠s
                                    const atualizarDistritos = () => {
                                        const isPortugal = paisSelect.value === "portugal";
                                        setDisabled(distritoSelect, !isPortugal);
                                        setDisabled(concelhoSelect, true);
                                        concelhoSelect.innerHTML = '<option value="">Todos os distritos</option>';
                                    };

                                    // Preenche os concelhos com base no distrito selecionado
                                    const preencherConcelhos = () => {
                                        const concelhos = distritosConcelhos[distritoSelect.value] || [];
                                        concelhoSelect.innerHTML = '<option value="">Todos os concelhos</option>';
                                        setDisabled(concelhoSelect, concelhos.length === 0);

                                        concelhos.forEach(nome => {
                                            const option = new Option(nome, nome.toLowerCase().replace(/\s+/g, '_'));
                                            concelhoSelect.appendChild(option);
                                        });
                                    };

                                    // Mostrar resultados ao clicar no bot√£o de pesquisa
                                    document.querySelector('#search-contracts-button').addEventListener('click', () => {
                                        const resultsTable = document.querySelector('#results-table');
                                        resultsTable.style.display = 'block';
                                        resultsTable.scrollIntoView({ behavior: 'smooth' });
                                    });

                                    let currentFilters = {}; // fora do escopo da fun√ß√£o

                                    // Envio do formul√°rio com AJAX
                                    document.querySelector('form[action="/base_gov"]').addEventListener('submit', e => {
                                        const submitter = e.submitter;

                                        // S√≥ prossegue se foi o bot√£o "Pesquisar"
                                        if (!submitter || submitter.id !== 'search-contracts-button') {
                                            e.preventDefault();
                                            return;
                                        }

                                        e.preventDefault();

                                        console.log('Enviando pesquisa...');
                                        const form = e.currentTarget;
                                        const formData = new FormData(form);
                                        const limit = document.getElementById('items-select')?.value || 25;

                                        currentFilters = {};
                                        formData.forEach((value, key) => {
                                            currentFilters[key] = value;
                                        });

                                        loadContracts(1, limit);
                                    });

                                    // Listeners de selects
                                    paisSelect.addEventListener('change', atualizarDistritos);
                                    distritoSelect.addEventListener('change', preencherConcelhos);


                                    // Abrir popup de download ao clicar em "Clique aqui"
                                    const openBtn = document.getElementById('openPopupBtn');
                                    const overlay = document.getElementById('overlay');
                                    if (openBtn && overlay) {
                                        openBtn.addEventListener('click', function (e) {
                                            e.preventDefault();
                                            overlay.style.display = 'flex';
                                            document.body.style.overflow = 'hidden';
                                        });
                                    }

                                    // Fechar popup (caso j√° n√£o tenha)
                                    const closeBtn = document.getElementById('closeBtn');
                                    if (closeBtn && overlay) {
                                        closeBtn.addEventListener('click', function () {
                                            overlay.style.display = 'none';
                                            document.body.style.overflow = 'auto';
                                        });
                                    }

                                    // --- Envio do c√≥digo ---
                                    const form = document.getElementById('downloadForm');
                                    const resendBtn = document.getElementById('resendCodeBtn');

                                    form.addEventListener('submit', async function (e) {
                                        e.preventDefault();

                                        const formData = new FormData(form);
                                        const data = Object.fromEntries(formData.entries());

                                        if (!data.email || data.email.trim() === '') {
                                            alert('Por favor, insira um email v√°lido.');
                                            return;
                                        }

                                        try {
                                            const response = await fetch('/components/mail_receive', {
                                                method: 'POST',
                                                headers: { 'Content-Type': 'application/json' },
                                                body: JSON.stringify(data)
                                            });

                                            const result = await response.json();
                                            if (result.success) {
                                                console.log('Email enviado com sucesso para: ' + data.email);
                                                // Avan√ßa para o pr√≥ximo passo
                                                document.getElementById('downloadStep1').classList.remove('active');
                                                document.getElementById('downloadStep2').classList.add('active');
                                            } else {
                                                alert('Erro ao enviar email: ' + (result.message || 'Tente novamente.'));
                                            }
                                        } catch (error) {
                                            alert('Erro ao enviar email: ' + error.message);
                                        }
                                    });

                                    // Reenvio do c√≥digo:
                                    if (resendBtn) {
                                        resendBtn.addEventListener('click', async function (e) {
                                            e.preventDefault();
                                            // Pegue os dados do formul√°rio preenchido
                                            const formData = new FormData(form);
                                            const data = Object.fromEntries(formData.entries());

                                            try {
                                                const response = await fetch('/components/mail_receive', {
                                                    method: 'POST',
                                                    headers: { 'Content-Type': 'application/json' },
                                                    body: JSON.stringify(data)
                                                });

                                                const result = await response.json();
                                                if (result.success) {
                                                    // Mostra a mensagem de reenvio
                                                    const resendMsg = document.getElementById('resend-message');
                                                    if (resendMsg) {
                                                        resendMsg.style.display = 'block';
                                                        // Esconde a mensagem ap√≥s 5 segundos (opcional)
                                                        setTimeout(() => { resendMsg.style.display = 'none'; }, 10000);
                                                    }
                                                    console.log('C√≥digo reenviado para o email: ' + data.email);
                                                } else {
                                                    alert('Erro ao reenviar c√≥digo: ' + (result.message || 'Tente novamente.'));
                                                }
                                            } catch (error) {
                                                alert('Erro ao reenviar c√≥digo: ' + error.message);
                                            }
                                        });
                                    }

                                    verifyCodeBtn.addEventListener('click', async () => {
                                        const inputs = document.querySelectorAll(".verification-input");
                                        const code = [...inputs].map(i => i.value).join("");

                                        if (code.length !== 5 || !/^\d{5}$/.test(code)) {
                                            alert("Por favor, insira um c√≥digo de 5 d√≠gitos.");
                                            return;
                                        }

                                        try {
                                            const response = await fetch('/components/verify_code', {
                                                method: 'POST',
                                                headers: { 'Content-Type': 'application/json' },
                                                body: JSON.stringify({ code })
                                            });

                                            const result = await response.json();
                                            if (result.success) {
                                                // üëâ Avan√ßar para a etapa 3
                                                document.getElementById('downloadStep2').classList.remove('active');
                                                document.getElementById('downloadStep3').classList.add('active');

                                                // üëâ Iniciar o download automaticamente
                                                const downloadLink = document.getElementById('downloadLink');
                                                if (downloadLink) {
                                                    downloadLink.click();
                                                }
                                            } else {
                                                alert(result.message || "C√≥digo incorreto.");
                                            }
                                        } catch (err) {
                                            alert("Erro ao verificar o c√≥digo: " + err.message);
                                        }
                                    });


                                });

                            </script>

</body>

</html>