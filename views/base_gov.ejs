<!DOCTYPE html>
<html lang="pt-pt">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/base_gov.css">
    <!-- Include Lucide icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <title>Helpdesk Público</title>
</head>

<body>

    <main class="container py-8">
        <h1 class="titulo">Estatísticas Mercado Público</h1>
        <div class="banner">
            <p>
                Bem-vindos à página de estatísticas do Helpdesk Público. <br>
                Aqui encontra toda a informação pública sobre os Contratos de Compras Públicas. <br>
                Consulte todas as informações sobre os Contratos Públicos de forma mais ágil e prática. <br>

            </p>
        </div>

        <div class="info-box">
            <p>Nos campos de seleção disponíveis deve selecionar as opções pretendidas para realizar a sua pesquisa,
                quanto maior for a seleção de campos mais reduzida será a lista de resultados.</p>
            <p>Pode realizar qualquer tipo de seleção, seja um objeto ou um espaço temporal, ou os dois.

                Caso não encontre o resultado desejado, reinicie a página e se possível elimine os cookies.

                Caso tenha dificuldade e necessite de suporte, regresse à página inicial das estatísticas e procure
                suporte na janela do chat ou através dos contactos disponibilizados no nosso website.</p>
        </div>
        </div>

        <form action="/base_gov" method="get">
            <div class="search-container">
                <div class="search-row">
                    <input type="text" name="search" placeholder="Pesquisar pelo objeto do Contrato"
                        class="search-input" />
                </div>

                <!-- Advanced Search Form -->
                <div id="advanced-search-form" class="advanced-search-form">
                    <div class="form-content">
                        <!-- First Row -->
                        <div class="form-row">
                            <div class="form-group">
                                <input type="checkbox" id="special-measures" name="special-measures"
                                    class="form-checkbox" />
                                <div class="tooltip-container">
                                    <label for="special-measures" class="form-label">
                                        Medidas especiais
                                    </label>
                                    <i data-lucide="info" class="info-icon"></i>
                                    <div class="tooltip">
                                        Medidas especiais aplicáveis aos contratos públicos de acordo com a Lei n.º
                                        30/2021, de 21 de maio.
                                        Inclui medidas para projetos financiados por fundos europeus, habitação,
                                        tecnologias de informação,
                                        saúde e outros setores específicos.
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <input type="checkbox" id="include-mec" name="include-mec" class="form-checkbox" />
                                <div class="tooltip-container">
                                    <label for="include-mec" class="form-label">
                                        Incluir MEC ao abrigo do CCP
                                    </label>
                                    <i data-lucide="info" class="info-icon"></i>
                                    <div class="tooltip">
                                        Assinale para pesquisar procedimentos lançados ao abrigo do CCP com uma
                                        tipologia das medidas especiais
                                    </div>
                                </div>
                            </div>

                            <div class="form-field">
                                <div class="tooltip-container">
                                    <label for="measure-type" class="form-label">
                                        Tipologia da medida especial
                                    </label>
                                    <i data-lucide="info" class="info-icon"></i>
                                    <div class="tooltip">
                                        Para escolher a tipologia das medidas especiais assinale pelo menos uma das
                                        caixas anteriores
                                    </div>
                                </div>
                                <select id="measure-type" name="measure-type" class="form-select" disabled>
                                    <option>Todos</option>
                                    <option>Projetos financiados ou cofinanciados por fundos europeus - artigo 2º da Lei
                                        n.º 30/2021</option>
                                    <option>Habitação e descentralização - artigo 3º da Lei n.º 30/2021</option>
                                    <option>Tecnologias de informação e conhecimento - artigo 4º da Lei n.º 30/2021
                                    </option>
                                    <option>Setor da saúde e do apoio social - artigo 5º da Lei n.º 30/2021</option>
                                    <option>Plano de Recuperação e Resiliência (PRR) - artigo 2º da Lei n.º 30/2021, DL
                                        n.º 78/2022</option>
                                    <option>Sistema de Gestão Integrada de Fogos Rurais - artigo 7º da Lei n.º 30/2021
                                    </option>
                                    <option>Bens agro-alimentares - artigo 8º da Lei n.º 30/2021</option>
                                    <option>Programa de Estabilização Económica e Social (PEES) - artigo 6º da Lei n.º
                                        30/2021</option>
                                    <option>Plano de Recuperação e Resiliência (PRR) - artigo 6º da Lei n.º 30/2021
                                    </option>
                                    <option>Regime especial de empreitadas de conceção-construção - artigo 2º-A da Lei
                                        n.º 30/2021, DL n.º 78/2022</option>
                                </select>
                            </div>
                        </div>

                        <hr class="form-divider" />

                        <!-- Second Row -->
                        <div class="form-row">
                            <div class="form-field">
                                <label for="procedure-type" class="form-label">
                                    Tipo de Procedimento
                                </label>
                                <select id="procedure-type" name="tipoProcedimento" class="form-select">
                                    <option value="0">Todos</option>
                                    <option value="8">Consulta Prévia</option>
                                    <option value="1">Ajuste Direto Regime Geral</option>
                                    <option value="2">Concurso público</option>
                                    <option value="3">Concurso limitado por prévia qualificação</option>
                                    <option value="4">Procedimento de negociação</option>
                                    <option value="5">Diálogo concorrencial</option>
                                    <option value="6">Ao abrigo de acordo-quadro (art.º 258.º)</option>
                                    <option value="7">Ao abrigo de acordo-quadro (art.º 259.º)</option>
                                    <option value="9">Parceria para a inovação</option>
                                    <option value="10">Disponibilização de bens móveis</option>
                                    <option value="11">Serviços sociais e outros serviços específicos</option>
                                    <option value="13">Concurso de conceção simplificado</option>
                                    <option value="14">Concurso de ideias simplificado</option>
                                    <option value="15">Consulta Prévia Simplificada</option>
                                    <option value="16">Concurso público simplificado</option>
                                    <option value="17">Concurso limitado por prévia qualificação simplificado</option>
                                    <option value="18">Ajuste Direto Regime Geral ao abrigo do artigo 7º da Lei n.º
                                        30/2021, de 21.05</option>
                                    <option value="19">Consulta prévia ao abrigo do artigo 7º da Lei n.º 30/2021, de
                                        21.05</option>
                                    <option value="20">Ajuste direto simplificado</option>
                                    <option value="21">Ajuste direto simplificado ao abrigo da Lei n.º 30/2021, de 21.05
                                    </option>
                                    <option value="22">Setores especiais - isenção parte II</option>
                                    <option value="23">Contratação excluída II</option>
                                </select>
                            </div>

                            <div class="form-field">
                                <div class="tooltip-container">
                                    <label for="entity" class="form-label">
                                        Entidade Adjudicante
                                    </label>
                                    <i data-lucide="info" class="info-icon"></i>
                                    <div class="tooltip">
                                        Pode pesquisar pelo NIPC ou descrição da entidade
                                    </div>
                                </div>
                                <input type="text" name="entidade" id="entity" class="form-input" />
                            </div>
                        </div>

                        <!-- Third Row -->
                        <div class="form-row">
                            <div class="form-field">
                                <label for="contract-type" class="form-label">
                                    Tipo de Contrato
                                </label>
                                <select id="contract-type" name="tipoContrato" class="form-select">
                                    <option value="0">Todos</option>
                                    <option value="1">Aquisição de bens móveis</option>
                                    <option value="2">Aquisição de serviços</option>
                                    <option value="3">Concessão de obras públicas</option>
                                    <option value="4">Concessão de serviços públicos</option>
                                    <option value="5">Empreitadas de obras públicas</option>
                                    <option value="6">Locação de bens móveis</option>
                                    <option value="7">Sociedade</option>
                                    <option value="8">Outros</option>
                                </select>
                            </div>

                            <div class="form-field">
                                <div class="tooltip-container">
                                    <label for="awarded-entity" class="form-label">
                                        Entidade Adjudicatária
                                    </label>
                                    <i data-lucide="info" class="info-icon"></i>
                                    <div class="tooltip">
                                        Pode pesquisar pelo NIPC ou descrição da entidade
                                    </div>
                                </div>
                                <input type="text" id="awarded-entity" name="adjudicatario" class="form-input" />
                            </div>
                        </div>

                        <!-- Fourth Row -->
                        <div class="form-row">
                            <div class="form-field">
                                <div class="tooltip-container">
                                    <label for="cpv" class="form-label">
                                        CPV
                                    </label>
                                    <i data-lucide="info" class="info-icon"></i>
                                    <div class="tooltip">
                                        Pode pesquisar pelo código ou descrição do Vocabulário Comum para os Contratos
                                        Públicos"
                                    </div>
                                </div>
                                <input type="text" name="cpv" id="cpv" class="form-input" />
                            </div>

                            <div class="form-group">
                                <input type="hidden" name="environmental-criteria" value="off" />
                                <input type="checkbox" id="environmental-criteria" name="environmental-criteria"
                                    class="form-checkbox" value="on" />

                                <label for="environmental-criteria" class="form-label">
                                    Critérios ambientais
                                </label>
                            </div>

                        </div>

                        <!-- Fifth Row - Dates and Location -->
                        <div class="form-row">
                            <div class="form-field date-container">
                                <div class="tooltip-container">
                                    <label for="date-type" class="form-label">
                                        Datas
                                    </label>
                                    <i data-lucide="info" class="info-icon"></i>
                                    <div class="tooltip">
                                        Pode pesquisar em simultâneo pelos vários intervalos de datas
                                    </div>
                                </div>
                                <select id="date-type" name="date-type" class="form-select">
                                    <option value="0">Data de Publicação</option>
                                    <option value="1">Data do Contrato</option>
                                    <option value="2">Data de Fecho</option>
                                </select>

                                <div class="date-range">
                                    <div class="date-field">
                                        <label for="date-from" class="form-label">De:</label>
                                        <div class="date-selects">
                                            <select id="from-year" name="from-year" class="date-select"></select>
                                            <select id="from-month" name="from-month" class="date-select"></select>
                                            <select id="from-day" name="from-day" class="date-select"></select>
                                        </div>
                                    </div>

                                    <div class="date-field">
                                        <label for="date-to" class="form-label">Até:</label>
                                        <div class="date-selects">
                                            <select id="to-year" name="to-year" class="date-select"></select>
                                            <select id="to-month" name="to-month" class="date-select"></select>
                                            <select id="to-day" name="to-day" class="date-select"></select>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="form-field location-container">
                                <label class="form-label">
                                    Local de Execução (País, Distrito, Concelho)
                                </label>
                                <select id="pais-select" name="pais" class="form-select location-select">
                                    <option>Todos</option>
                                    <option value="portugal">Portugal</option>
                                    <option value="espanha">Outro</option>
                                </select>
                                </select>
                                <select id="distrito-select" name="distrito" class="form-select location-select"
                                    disabled>
                                    <option value="">Todos os distrito</option>
                                    <option value="aveiro">Aveiro</option>
                                    <option value="beja">Beja</option>
                                    <option value="braga">Braga</option>
                                    <option value="braganca">Bragança</option>
                                    <option value="castelo_branco">Castelo Branco</option>
                                    <option value="coimbra">Coimbra</option>
                                    <option value="evora">Évora</option>
                                    <option value="faro">Faro</option>
                                    <option value="guarda">Guarda</option>
                                    <option value="leiria">Leiria</option>
                                    <option value="lisboa">Lisboa</option>
                                    <option value="portalegre">Portalegre</option>
                                    <option value="porto">Porto</option>
                                    <option value="santarem">Santarém</option>
                                    <option value="setubal">Setúbal</option>
                                    <option value="viana_do_castelo">Viana do Castelo</option>
                                    <option value="vila_real">Vila Real</option>
                                    <option value="viseu">Viseu</option>
                                </select>
                                <select id="concelho-select" name="concelho" class="form-select location-select"
                                    disabled>
                                    <option value="">Todos os concelhos</option>
                                    <!-- Será preenchido dinamicamente com JavaScript -->
                                </select>
                            </div>
                        </div>

                        <!-- Form Buttons -->
                        <div class="form-buttons">
                            <button id="clear-form-btn" class="clear-button">
                                <i data-lucide="x" class="icon-small"></i>
                                <span>LIMPAR</span>
                            </button>
                            <button type="submit" id="search-contracts-button" class="submit-button">
                                <i data-lucide="search" class="icon-small"></i>
                                <span>PESQUISAR</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </main>


    <div class="custom-notif__container" id="notificacao-container" style="display: none;">
        <div class="custom-notif__wrapper">
            <div class="custom-notif__content">
                <div class="custom-notif__icon">
                    <i class="fas fa-envelope"></i>
                </div>
                <div class="custom-notif__text">
                    Deseja fazer download desta informação?
                    <a class="custom-notif__link" id="openPopupBtn">Clique aqui</a> e após inserir os seus dados
                    iniciar-se-á o download.
                </div>
            </div>
            <button class="custom-notif__close"
                onclick="document.getElementById('notificacao-container').style.display='none'">
                &times;
            </button>
        </div>
    </div>

    <% if (typeof contracts !=='undefined' ) { %>
        <%- include('components/tab_base', {contracts: contracts}) %>
            <% } else { %>
                <div class="no-contracts">
                    <p>Nenhum dado de contrato disponível no momento.</p>
                </div>
                <% } %>

                    <%- include('components/mail_receive') %>
                        <%- include('components/button') %>

                            <script>
                                document.addEventListener('DOMContentLoaded', () => {
                                    console.log('DOM carregado');

                                    // ========== Utils ==========
                                    const qs = (s, p = document) => p.querySelector(s);
                                    const qsa = (s, p = document) => [...p.querySelectorAll(s)];

                                    // ========== Preencher selects de data ==========
                                    function populateDateSelectors(yearId, monthId, dayId) {
                                        const yearSelect = document.getElementById(yearId);
                                        const monthSelect = document.getElementById(monthId);
                                        const daySelect = document.getElementById(dayId);

                                        const currentYear = new Date().getFullYear();

                                        // Placeholders
                                        yearSelect.innerHTML = '<option disabled selected>Ano:</option>';
                                        monthSelect.innerHTML = '<option disabled selected>Mês:</option>';
                                        daySelect.innerHTML = '<option disabled selected>Dia:</option>';

                                        // Preencher anos (do ano atual até 1900)
                                        for (let y = currentYear; y >= 1900; y--) {
                                            yearSelect.innerHTML += `<option value="${y}">${y}</option>`;
                                        }

                                        // Preencher meses (01 a 12)
                                        for (let m = 1; m <= 12; m++) {
                                            const paddedMonth = m.toString().padStart(2, '0');
                                            monthSelect.innerHTML += `<option value="${m}">${paddedMonth}</option>`;
                                        }

                                        // Atualizar dias com base no mês e ano selecionados
                                        function updateDays() {
                                            const year = parseInt(yearSelect.value);
                                            const month = parseInt(monthSelect.value);

                                            if (!year || !month) return;

                                            const daysInMonth = new Date(year, month, 0).getDate();
                                            daySelect.innerHTML = '<option disabled selected>Dia:</option>';

                                            for (let d = 1; d <= daysInMonth; d++) {
                                                const paddedDay = d.toString().padStart(2, '0');
                                                daySelect.innerHTML += `<option value="${d}">${paddedDay}</option>`;
                                            }
                                        }

                                        yearSelect.addEventListener('change', updateDays);
                                        monthSelect.addEventListener('change', updateDays);

                                        yearSelect.selectedIndex = 0;
                                        monthSelect.selectedIndex = 0;
                                        daySelect.selectedIndex = 0;
                                    }

                                    populateDateSelectors('from-year', 'from-month', 'from-day');
                                    populateDateSelectors('to-year', 'to-month', 'to-day');


                                    // ========== Ícones Lucide ==========
                                    (typeof lucide === 'undefined' ? { createIcons: () => { } } : lucide).createIcons();

                                    // ========== Limpar formulário ==========
                                    document.querySelector('#clear-form-btn')?.addEventListener('click', (e) => {
                                        e.preventDefault(); // Impede o submit
                                        const form = document.querySelector('form[action="/base_gov"]');
                                        if (!form) return;

                                        form.reset(); // Limpa todos os campos automaticamente

                                        // Para selects com value="0" ou "Todos"
                                        form.querySelectorAll('select').forEach(select => {
                                            select.selectedIndex = 0;
                                        });

                                        // Para os selects dependentes (desabilita)
                                        const measureTypeSelect = document.getElementById('measure-type');
                                        if (measureTypeSelect) measureTypeSelect.disabled = true;

                                        const distritoSelect = document.getElementById('distrito-select');
                                        if (distritoSelect) distritoSelect.disabled = true;

                                        const concelhoSelect = document.getElementById('concelho-select');
                                        if (concelhoSelect) concelhoSelect.disabled = true;
                                    });

                                    // ========== Mostrar resultados ==========
                                    const resultsTable = qs('#results-table');
                                    const notifContainer = qs('#notificacao-container');
                                    qsa('.search-button, .submit-button').forEach(btn =>
                                        btn.addEventListener('click', () => {
                                            resultsTable?.style.setProperty('display', 'block');
                                            notifContainer?.style.setProperty('display', 'block'); // Mostra a notificação só após pesquisa
                                            resultsTable?.scrollIntoView({ behavior: 'smooth' });
                                        })
                                    )

                                    // Referências aos elementos(faz bloquear e desbloquear as dropdowns se ela for selecionada)
                                    const checkboxes = [
                                        document.getElementById('special-measures'),
                                        document.getElementById('include-mec')
                                    ];
                                    const measureTypeSelect = document.getElementById('measure-type');
                                    // Função para atualizar o estado do dropdown
                                    const updateDropdownState = () => {
                                        measureTypeSelect.disabled = !checkboxes.some(cb => cb.checked);
                                    };
                                    // Adicionar evento a todos os checkboxes
                                    checkboxes.forEach(cb => cb.addEventListener('change', updateDropdownState));
                                    // Estado inicial
                                    updateDropdownState();

                                    // ========== Listar os Conselhos ==========
                                    // Referências aos elementos
                                    const paisSelect = document.getElementById('pais-select');
                                    const distritoSelect = document.getElementById('distrito-select');
                                    const concelhoSelect = document.getElementById('concelho-select');
                                    const distritosConcelhos = {
                                        aveiro: ["Águeda", "Albergaria-a-Velha", "Anadia", "Arouca", "Aveiro", "Castelo de Paiva", "Espinho", "Estarreja", "Ílhavo", "Mealhada", "Murtosa", "Oliveira de Azeméis", "Oliveira do Bairro", "Ovar", "Santa Maria da Feira", "São João da Madeira", "Sever do Vouga", "Vagos", "Vale de Cambra"],
                                        beja: ["Aljustrel", "Almodôvar", "Alvito", "Barrancos", "Beja", "Castro Verde", "Cuba", "Ferreira do Alentejo", "Mértola", "Moura", "Odemira", "Ourique", "Serpa", "Vidigueira"],
                                        braga: ["Amares", "Barcelos", "Braga", "Cabeceiras de Basto", "Celorico de Basto", "Esposende", "Fafe", "Guimarães", "Póvoa de Lanhoso", "Terras de Bouro", "Vieira do Minho", "Vila Nova de Famalicão", "Vila Verde", "Vizela"],
                                        braganca: ["Alfândega da Fé", "Bragança", "Carrazeda de Ansiães", "Freixo de Espada à Cinta", "Macedo de Cavaleiros", "Miranda do Douro", "Mirandela", "Mogadouro", "Torre de Moncorvo", "Vila Flor", "Vimioso", "Vinhais"],
                                        castelo_branco: ["Belmonte", "Castelo Branco", "Covilhã", "Fundão", "Idanha-a-Nova", "Oleiros", "Penamacor", "Proença-a-Nova", "Sertã", "Vila de Rei", "Vila Velha de Ródão"],
                                        coimbra: ["Arganil", "Cantanhede", "Coimbra", "Condeixa-a-Nova", "Figueira da Foz", "Góis", "Lousã", "Mira", "Miranda do Corvo", "Montemor-o-Velho", "Oliveira do Hospital", "Pampilhosa da Serra", "Penacova", "Penela", "Soure", "Tábua", "Vila Nova de Poiares"],
                                        evora: ["Alandroal", "Arraiolos", "Borba", "Estremoz", "Évora", "Montemor-o-Novo", "Mora", "Mourão", "Portel", "Redondo", "Reguengos de Monsaraz", "Vendas Novas", "Viana do Alentejo", "Vila Viçosa"],
                                        faro: ["Albufeira", "Alcoutim", "Aljezur", "Castro Marim", "Faro", "Lagoa", "Lagos", "Loulé", "Monchique", "Olhão", "Portimão", "São Brás de Alportel", "Silves", "Tavira", "Vila do Bispo", "Vila Real de Santo António"],
                                        guarda: ["Aguiar da Beira", "Almeida", "Celorico da Beira", "Figueira de Castelo Rodrigo", "Fornos de Algodres", "Gouveia", "Guarda", "Manteigas", "Mêda", "Pinhel", "Sabugal", "Seia", "Trancoso", "Vila Nova de Foz Côa"],
                                        leiria: ["Alcobaça", "Alvaiázere", "Ansião", "Batalha", "Bombarral", "Caldas da Rainha", "Castanheira de Pêra", "Figueiró dos Vinhos", "Leiria", "Marinha Grande", "Nazaré", "Óbidos", "Pedrógão Grande", "Peniche", "Pombal", "Porto de Mós"],
                                        lisboa: ["Alenquer", "Amadora", "Arruda dos Vinhos", "Azambuja", "Cadaval", "Cascais", "Lisboa", "Loures", "Lourinhã", "Mafra", "Odivelas", "Oeiras", "Sintra", "Sobral de Monte Agraço", "Torres Vedras", "Vila Franca de Xira"],
                                        portalegre: ["Alter do Chão", "Arronches", "Avis", "Campo Maior", "Castelo de Vide", "Crato", "Elvas", "Fronteira", "Gavião", "Marvão", "Monforte", "Nisa", "Ponte de Sor", "Portalegre", "Sousel"],
                                        porto: ["Amarante", "Baião", "Felgueiras", "Gondomar", "Lousada", "Maia", "Marco de Canaveses", "Matosinhos", "Paços de Ferreira", "Paredes", "Penafiel", "Porto", "Póvoa de Varzim", "Santo Tirso", "São João da Madeira", "Trofa", "Valongo", "Vila do Conde", "Vila Nova de Gaia"],
                                        santarem: ["Abrantes", "Alcanena", "Almeirim", "Alpiarça", "Benavente", "Cartaxo", "Chamusca", "Constância", "Coruche", "Entroncamento", "Ferreira do Zêzere", "Golegã", "Mação", "Ourém", "Rio Maior", "Salvaterra de Magos", "Santarém", "Sardoal", "Tomar", "Torres Novas", "Vila Nova da Barquinha"],
                                        setubal: ["Alcácer do Sal", "Almada", "Barreiro", "Grândola", "Moita", "Montijo", "Palmela", "Santiago do Cacém", "Seixal", "Sesimbra", "Setúbal", "Sines"],
                                        viana_do_castelo: ["Arcos de Valdevez", "Caminha", "Melgaço", "Monção", "Paredes de Coura", "Ponte da Barca", "Ponte de Lima", "Valença", "Viana do Castelo", "Vila Nova de Cerveira"],
                                        vila_real: ["Alijó", "Boticas", "Chaves", "Mesão Frio", "Mondim de Basto", "Montalegre", "Murça", "Peso da Régua", "Ribeira de Pena", "Sabrosa", "Santa Marta de Penaguião", "Valpaços", "Vila Pouca de Aguiar", "Vila Real"],
                                        viseu: ["Armamar", "Carregal do Sal", "Castro Daire", "Cinfães", "Lamego", "Mangualde", "Moimenta da Beira", "Mortágua", "Nelas", "Oliveira de Frades", "Penalva do Castelo", "Penedono", "Resende", "Santa Comba Dão", "São João da Pesqueira", "São Pedro do Sul", "Sátão", "Sernancelhe", "Tabuaço", "Tarouca", "Tondela", "Vila Nova de Paiva", "Viseu", "Vouzela"]
                                    };
                                    // Utilitário para ativar/desativar <select>
                                    const setDisabled = (select, disabled) => {
                                        select.disabled = disabled;
                                        if (disabled) select.value = "";
                                    };

                                    // Atualiza o estado dos selects de distrito e concelho com base no país
                                    const atualizarDistritos = () => {
                                        const isPortugal = paisSelect.value === "portugal";
                                        setDisabled(distritoSelect, !isPortugal);
                                        setDisabled(concelhoSelect, true);
                                        concelhoSelect.innerHTML = '<option value="">Todos os distritos</option>';
                                    };

                                    // Preenche os concelhos com base no distrito selecionado
                                    const preencherConcelhos = () => {
                                        const concelhos = distritosConcelhos[distritoSelect.value] || [];
                                        concelhoSelect.innerHTML = '<option value="">Todos os concelhos</option>';
                                        setDisabled(concelhoSelect, concelhos.length === 0);

                                        concelhos.forEach(nome => {
                                            const option = new Option(nome, nome.toLowerCase().replace(/\s+/g, '_'));
                                            concelhoSelect.appendChild(option);
                                        });
                                    };

                                    // Mostrar resultados ao clicar no botão de pesquisa
                                    document.querySelector('#search-contracts-button').addEventListener('click', () => {
                                        const resultsTable = document.querySelector('#results-table');
                                        resultsTable.style.display = 'block';
                                        resultsTable.scrollIntoView({ behavior: 'smooth' });
                                    });

                                    let currentFilters = {}; // fora do escopo da função

                                    // Envio do formulário com AJAX
                                    document.querySelector('form[action="/base_gov"]').addEventListener('submit', e => {
                                        const submitter = e.submitter;

                                        // Só prossegue se foi o botão "Pesquisar"
                                        if (!submitter || submitter.id !== 'search-contracts-button') {
                                            e.preventDefault();
                                            return;
                                        }

                                        e.preventDefault();

                                        console.log('Enviando pesquisa...');
                                        const form = e.currentTarget;
                                        const formData = new FormData(form);
                                        const limit = document.getElementById('items-select')?.value || 25;

                                        currentFilters = {};
                                        formData.forEach((value, key) => {
                                            currentFilters[key] = value;
                                        });

                                        loadContracts(1, limit);
                                    });

                                    // Listeners de selects
                                    paisSelect.addEventListener('change', atualizarDistritos);
                                    distritoSelect.addEventListener('change', preencherConcelhos);


                                    // Abrir popup de download ao clicar em "Clique aqui"
                                    const openBtn = document.getElementById('openPopupBtn');
                                    const overlay = document.getElementById('overlay');
                                    if (openBtn && overlay) {
                                        openBtn.addEventListener('click', function (e) {
                                            e.preventDefault();
                                            overlay.style.display = 'flex';
                                            document.body.style.overflow = 'hidden';
                                        });
                                    }

                                    // Fechar popup (caso já não tenha)
                                    const closeBtn = document.getElementById('closeBtn');
                                    if (closeBtn && overlay) {
                                        closeBtn.addEventListener('click', function () {
                                            overlay.style.display = 'none';
                                            document.body.style.overflow = 'auto';
                                        });
                                    }

                                    // --- Envio e reenvio do código ---
                                    const form = document.getElementById('downloadForm');
                                    const resendBtn = document.getElementById('resendCodeBtn');

                                    form.addEventListener('submit', async function (e) {
                                        e.preventDefault();

                                        const formData = new FormData(form);
                                        const data = Object.fromEntries(formData.entries());

                                        try {
                                            const response = await fetch('/components/mail_receiver', {
                                                method: 'POST',
                                                headers: { 'Content-Type': 'application/json' },
                                                body: JSON.stringify(data)
                                            });

                                            const result = await response.json();
                                            if (result.success) {
                                                console.log('Código enviado para o email:', data.email); // <-- Adicionado
                                                // Avança para o passo 2 (verificação)
                                                document.getElementById('downloadStep1').classList.remove('active');
                                                document.getElementById('downloadStep2').classList.add('active');
                                            } else {
                                                alert('Erro ao enviar email: ' + (result.message || 'Tente novamente.'));
                                            }
                                        } catch (error) {
                                            alert('Erro ao enviar email: ' + error.message);
                                        }
                                    });
                                });

                            </script>

</body>

</html>