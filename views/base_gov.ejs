<!DOCTYPE html>
<html lang="pt-pt">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="base_gov.css">
    <!-- Include Lucide icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <title>Helpdesk Público</title>
</head>

<body>

    <main class="container py-8">
        <h1 class="titulo">Estatísticas Mercado Público</h1>
        <div class="banner">
            <p>
                Bem-vindos à página de estatísticas do Helpdesk Público. <br>
                Aqui encontra toda a informação pública sobre os Contratos de Compras Públicas. <br>
                Consulte todas as informações sobre os Contratos Públicos de forma mais ágil e prática. <br>

            </p>
        </div>

        <div class="info-box">
            <p>Nos campos de seleção disponíveis deve selecionar as opções pretendidas para realizar a sua pesquisa,
                quanto maior for a seleção de campos mais reduzida será a lista de resultados.</p>
            <p>Pode realizar qualquer tipo de seleção, seja um objeto ou um espaço temporal, ou os dois.

                Caso não encontre o resultado desejado, reinicie a página e se possível elimine os cookies.

                Caso tenha dificuldade e necessite de suporte, regresse à página inicial das estatísticas e procure
                suporte na janela do chat ou através dos contactos disponibilizados no nosso website.</p>
        </div>
        </div>

        <form action="/base_gov" method="get">
            <div class="search-container">
                <div class="search-row">
                    <div class="dropdown" id="contracts-dropdown">
                        <button id="dropdown-button" class="dropdown-select" aria-haspopup="true" aria-expanded="false">
                            <span class="dropdown-text" id="selected-contract">Contrato</span>
                            <i data-lucide="chevron-down" class="dropdown-icon"></i>
                        </button>

                        <div class="dropdown-menu" id="dropdown-menu">
                            <div class="dropdown-item" data-value="Contrato">Contratos</div>
                            <div class="dropdown-item" data-value="Entidades">Entidades</div>
                            <div class="dropdown-item" data-value="Modificações contratuais">Modificações contratuais
                            </div>
                            <div class="dropdown-item" data-value="Bens móveis">Bens móveis</div>
                            <div class="dropdown-item" data-value="Não Celebrações de contrato">Não Celebrações de
                                contrato
                            </div>
                            <div class="dropdown-item" data-value="Impugnação">Impugnações</div>
                        </div>
                    </div>
                    <input type="text" placeholder="Pesquisar pelo objeto do Contrato" class="search-input" />
                    <!-- <button type="submit" id="search-contracts-button" class="search-button">
                        <i data-lucide="search" class="icon-small"></i>
                        <span>Pesquisar</span>
                    </button> -->
                </div>

                <!-- Advanced Search Form -->
                <div id="advanced-search-form" class="advanced-search-form">
                    <div class="form-content">
                        <!-- First Row -->
                        <div class="form-row">
                            <div class="form-group">
                                <input type="checkbox" id="special-measures" class="form-checkbox" />
                                <label for="special-measures" class="form-label info-hover">
                                    Medidas especiais
                                    <span class="info-icon">
                                        <div class="icon-info"></div>
                                        <span class="tooltip">Assinale para pesquisar procedimentos ao abrigo das
                                            medidas especiais - lei n.º 30/2021</span>
                                    </span>
                                </label>
                            </div>

                            <div class="form-group">
                                <input type="checkbox" id="include-mec" class="form-checkbox" />
                                <label for="include-mec" class="form-label info-hover">
                                    Incluir MEC ao abrigo do CCP
                                    <span class="info-icon">
                                        <div class="icon-info"></div>
                                        <span class="tooltip">Assinale para pesquisar procedimentos lançados ao abrigo
                                            do CCP com uma tipologia das medidas especiais</span>
                                    </span>
                                </label>
                            </div>

                            <div class="form-field">
                                <label for="measure-type" class="form-label info-hover">
                                    Tipologia da medida especial
                                    <span class="info-icon">
                                        <div class="icon-info"></div>
                                        <span class="tooltip">Para escolher a tipologia das medidas especiais assinal
                                            pelo menos uma das caixas anteriores/span>
                                        </span>
                                </label>
                                <select id="measure-type" class="form-select" disabled>
                                    <option>Todos</option>
                                    <option>Projetos financiados ou cofinanciados por fundos europeus - artigo 2º da Lei
                                        n.º 30/2021</option>
                                    <option>Habitação e descentralização - artigo 3º da Lei n.º 30/2021</option>
                                    <option>Tecnologias de informação e conhecimento - artigo 4º da Lei n.º 30/2021
                                    </option>
                                    <option>Setor da saúde e do apoio social - artigo 5º da Lei n.º 30/2021</option>
                                    <option>Plano de Recuperação e Resiliência (PRR) - artigo 2º da Lei n.º 30/2021, DL
                                        n.º 78/2022</option>
                                    <option>Sistema de Gestão Integrada de Fogos Rurais - artigo 7º da Lei n.º 30/2021
                                    </option>
                                    <option>Bens agro-alimentares - artigo 8º da Lei n.º 30/2021</option>
                                    <option>Programa de Estabilização Económica e Social (PEES) - artigo 6º da Lei n.º
                                        30/2021</option>
                                    <option>Plano de Recuperação e Resiliência (PRR) - artigo 6º da Lei n.º 30/2021
                                    </option>
                                    <option>Regime especial de empreitadas de conceção-construção - artigo 2º-A da Lei
                                        n.º 30/2021, DL n.º 78/2022</option>
                                </select>
                            </div>
                        </div>

                        <hr class="form-divider" />

                        <!-- Second Row -->
                        <div class="form-row">
                            <div class="form-field">
                                <label for="procedure-type" class="form-label">
                                    Tipo de Procedimento
                                </label>
                                <select id="procedure-type" class="form-select">
                                    <!-- opções omitidas por brevidade -->
                                </select>
                            </div>

                            <div class="form-field">
                                <label for="entity" class="form-label info-hover">
                                    Entidade Adjudicante
                                    <span class="info-icon">
                                        <div class="icon-info"></div>
                                        <span class="tooltip">Pode pesquisar pelo NIPC ou descrição da entidade</span>
                                    </span>
                                </label>
                                <input type="text" id="entity" class="form-input" />
                            </div>
                        </div>

                        <!-- Third Row -->
                        <div class="form-row">
                            <div class="form-field">
                                <label for="contract-type" class="form-label">
                                    Tipo de Contrato
                                </label>
                                <select id="contract-type" class="form-select">
                                    <!-- opções omitidas por brevidade -->
                                </select>
                            </div>

                            <div class="form-field">
                                <label for="awarded-entity" class="form-label info-hover">
                                    Entidade Adjudicatária
                                    <span class="info-icon">
                                        <div class="icon-info"></div>
                                        <span class="tooltip">Pode pesquisar pelo NIPC ou descrição da entidade</span>
                                    </span>
                                </label>
                                <input type="text" id="awarded-entity" class="form-input" />
                            </div>
                        </div>

                        <!-- Fourth Row -->
                        <div class="form-row">
                            <div class="form-field">
                                <label for="cpv" class="form-label info-hover">
                                    CPV
                                    <span class="info-icon">
                                        <div class="icon-info"></div>
                                        <span class="tooltip">Pode pesquisar pelo código ou descrição do Vocabulário
                                            Comum para os contratos públicos</span>
                                    </span>
                                </label>
                                <input type="text" id="cpv" class="form-input" />
                            </div>

                            <div class="form-group">
                                <input type="checkbox" id="environmental-criteria" class="form-checkbox" />
                                <label for="environmental-criteria" class="form-label">
                                    Critérios ambientais
                                </label>
                            </div>
                        </div>

                        <!-- Fifth Row - Dates -->
                        <div class="form-row">
                            <div class="form-field date-container">
                                <label for="date-type" class="form-label info-hover">
                                    Datas
                                    <span class="info-icon">
                                        <div class="icon-info"></div>
                                        <span class="tooltip">Pode pesquisar em simultâneo pelos vários intervalos de
                                            datas</span>
                                    </span>
                                </label>
                                <select id="date-type" class="form-select">
                                    <option>Data do Contrato</option>
                                    <option>Data de Publicação</option>
                                    <option>Data de Fecho</option>
                                </select>

                                <div class="date-range">
                                    <div class="date-field">
                                        <label for="date-from" class="form-label">De:</label>
                                        <div class="date-selects">
                                            <select id="from-year" class="date-select"></select>
                                            <select id="from-month" class="date-select"></select>
                                            <select id="from-day" class="date-select"></select>
                                        </div>
                                    </div>

                                    <div class="date-field">
                                        <label for="date-to" class="form-label">Até:</label>
                                        <div class="date-selects">
                                            <select id="to-year" class="date-select"></select>
                                            <select id="to-month" class="date-select"></select>
                                            <select id="to-day" class="date-select"></select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-field location-container">
                            <label class="form-label">
                                Local de Execução (País, Distrito, Concelho)
                            </label>
                            <select id="pais-select" class="form-select location-select">
                                <option>Todos</option>
                                <option value="portugal">Portugal</option>
                                <option value="espanha">Outro</option>
                            </select>
                            </select>
                            <select id="distrito-select" class="form-select location-select" disabled>
                                <option value="">Todos</option>
                                <option value="aveiro">Aveiro</option>
                                <option value="beja">Beja</option>
                                <option value="braga">Braga</option>
                                <option value="braganca">Bragança</option>
                                <option value="castelo_branco">Castelo Branco</option>
                                <option value="coimbra">Coimbra</option>
                                <option value="evora">Évora</option>
                                <option value="faro">Faro</option>
                                <option value="guarda">Guarda</option>
                                <option value="leiria">Leiria</option>
                                <option value="lisboa">Lisboa</option>
                                <option value="portalegre">Portalegre</option>
                                <option value="porto">Porto</option>
                                <option value="santarem">Santarém</option>
                                <option value="setubal">Setúbal</option>
                                <option value="viana_do_castelo">Viana do Castelo</option>
                                <option value="vila_real">Vila Real</option>
                                <option value="viseu">Viseu</option>
                            </select>
                            <select id="concelho-select" class="form-select location-select" disabled>
                                <option value="">Selecione um concelho</option>
                                <!-- Será preenchido dinamicamente com JavaScript -->
                            </select>
                        </div>
                    </div>

                    <!-- Form Buttons -->
                    <div class="form-buttons">
                        <button id="clear-form-btn" class="clear-button">
                            <i data-lucide="x" class="icon-small"></i>
                            <span>LIMPAR</span>
                        </button>
                        <button type="submit" id="search-contracts-button" class="submit-button">
                            <i data-lucide="search" class="icon-small"></i>
                            <span>PESQUISAR</span>
                        </button>
                    </div>
                </div>
            </div>
            </div>
        </form>



    </main>

    <% if (typeof contracts !=='undefined' ) { %>
        <%- include('components/tab_base', {contracts: contracts}) %>
            <% } else { %>
                <div class="no-contracts">
                    <p>Nenhum dado de contrato disponível no momento.</p>
                </div>
                <% } %>
                    <%- include('components/detalhes') %>
                        <%- include('components/mail_receive') %>
                            <%- include('components/button') %>

                                <script>
                                    document.addEventListener('DOMContentLoaded', function () {
                                        // ========== Utils ==========
                                        const qs = (s, p = document) => p.querySelector(s);
                                        const qsa = (s, p = document) => [...p.querySelectorAll(s)];

                                        // ========== Preencher selects de data ==========
                                        function populateDateSelectors(yearId, monthId, dayId) {
                                            const yearSelect = document.getElementById(yearId);
                                            const monthSelect = document.getElementById(monthId);
                                            const daySelect = document.getElementById(dayId);

                                            const currentYear = new Date().getFullYear();

                                            // Placeholders
                                            yearSelect.innerHTML = '<option disabled selected>Ano:</option>';
                                            monthSelect.innerHTML = '<option disabled selected>Mês:</option>';
                                            daySelect.innerHTML = '<option disabled selected>Dia:</option>';

                                            // Preencher anos (do ano atual até 1900)
                                            for (let y = currentYear; y >= 1900; y--) {
                                                yearSelect.innerHTML += `<option value="${y}">${y}</option>`;
                                            }

                                            // Preencher meses (01 a 12)
                                            for (let m = 1; m <= 12; m++) {
                                                const paddedMonth = m.toString().padStart(2, '0');
                                                monthSelect.innerHTML += `<option value="${m}">${paddedMonth}</option>`;
                                            }

                                            // Atualizar dias com base no mês e ano selecionados
                                            function updateDays() {
                                                const year = parseInt(yearSelect.value);
                                                const month = parseInt(monthSelect.value);

                                                if (!year || !month) return;

                                                const daysInMonth = new Date(year, month, 0).getDate();
                                                daySelect.innerHTML = '<option disabled selected>Dia:</option>';

                                                for (let d = 1; d <= daysInMonth; d++) {
                                                    const paddedDay = d.toString().padStart(2, '0');
                                                    daySelect.innerHTML += `<option value="${d}">${paddedDay}</option>`;
                                                }
                                            }

                                            yearSelect.addEventListener('change', updateDays);
                                            monthSelect.addEventListener('change', updateDays);

                                            // Inicializar com valores padrão
                                            yearSelect.value = currentYear;
                                            monthSelect.value = 1;
                                            updateDays();
                                        }

                                        populateDateSelectors('from-year', 'from-month', 'from-day');
                                        populateDateSelectors('to-year', 'to-month', 'to-day');

                                        // --- Envio e reenvio do código ---
                                        const form = document.getElementById('downloadForm');
                                        const resendBtn = document.getElementById('resendCodeBtn');

                                        form.addEventListener('submit', async function (e) {
                                            e.preventDefault();

                                            const formData = new FormData(form);
                                            const data = Object.fromEntries(formData.entries());

                                            try {
                                                const response = await fetch('/api/send-email', {
                                                    method: 'POST',
                                                    headers: { 'Content-Type': 'application/json' },
                                                    body: JSON.stringify(data)
                                                });

                                                const result = await response.json();
                                                if (result.success) {
                                                    // Avança para o passo 2 (verificação)
                                                    document.getElementById('downloadStep1').classList.remove('active');
                                                    document.getElementById('downloadStep2').classList.add('active');
                                                } else {
                                                    alert('Erro ao enviar email: ' + (result.message || 'Tente novamente.'));
                                                }
                                            } catch (error) {
                                                alert('Erro ao enviar email: ' + error.message);
                                            }
                                        });

                                        resendBtn.addEventListener('click', async function (e) {
                                            e.preventDefault();

                                            const formData = new FormData(form);
                                            const data = Object.fromEntries(formData.entries());

                                            try {
                                                const response = await fetch('/api/send-email', {
                                                    method: 'POST',
                                                    headers: { 'Content-Type': 'application/json' },
                                                    body: JSON.stringify(data)
                                                });

                                                const result = await response.json();
                                                if (result.success) {
                                                    alert('Código reenviado para o seu email!');
                                                } else {
                                                    alert('Erro ao reenviar código: ' + (result.message || 'Tente novamente.'));
                                                }
                                            } catch (error) {
                                                alert('Erro ao reenviar código: ' + error.message);
                                            }
                                        });

                                        // ========== Ícones Lucide ==========
                                        (typeof lucide === 'undefined' ? { createIcons: () => { } } : lucide).createIcons();

                                        // ========== Limpar formulário ==========
                                        qs('#clear-form-btn')?.addEventListener('click', () => {
                                            const form = qs('#advancedSearchForm');
                                            form?.querySelectorAll('input').forEach(i => i.type === 'checkbox' ? i.checked = false : i.value = '');
                                            form?.querySelectorAll('select').forEach(s => s.selectedIndex = 0);
                                        });

                                        // ========== Mostrar resultados ==========
                                        const resultsTable = qs('#results-table');
                                        const notifContainer = qs('#notificacao-container');
                                        qsa('.search-button, .submit-button').forEach(btn =>
                                            btn.addEventListener('click', () => {
                                                resultsTable?.style.setProperty('display', 'block');
                                                notifContainer?.style.setProperty('display', 'block');
                                                resultsTable?.scrollIntoView({ behavior: 'smooth' });
                                            })
                                        );

                                        // ========== Detalhes de contratos ==========
                                        const contractDetails = qsa('.contract-details');
                                        const toggleDetail = (id, show) => {
                                            contractDetails.forEach(el => el.style.display = el.id === `details-${id}` && show ? 'block' : 'none');
                                            const btn = qs(`.details-button[data-contract-id="${id}"]`);
                                            const icon = btn?.querySelector('i');
                                            qs('#main-container')?.style.setProperty('display', show ? 'block' : 'none');
                                            icon?.classList.toggle('fa-plus-circle', !show);
                                            icon?.classList.toggle('fa-minus-circle', show);
                                            (show ? qs('#main-container') : qs('.results-table'))?.scrollIntoView({ behavior: 'smooth' });
                                        };

                                        qsa('.details-button').forEach(btn => {
                                            const id = btn.dataset.contractId;
                                            ['click', 'keydown'].forEach(evt => {
                                                btn.addEventListener(evt, e => {
                                                    if (evt === 'click' || ['Enter', ' '].includes(e.key)) {
                                                        e.preventDefault?.();
                                                        toggleDetail(id, true);
                                                    }
                                                });
                                            });
                                        });

                                        qsa('.close-details').forEach(btn => {
                                            const id = btn.dataset.contractId;
                                            ['click', 'keydown'].forEach(evt => {
                                                btn.addEventListener(evt, e => {
                                                    if (evt === 'click' || ['Enter', ' '].includes(e.key)) {
                                                        e.preventDefault?.();
                                                        toggleDetail(id, false);
                                                    }
                                                });
                                            });
                                        });

                                        // ========== Dropdown ==========
                                        const dropdownBtn = qs('#dropdown-button');
                                        const dropdownMenu = qs('#dropdown-menu');
                                        const searchInput = qs('.search-input');
                                        const selectedContract = qs('#selected-contract');

                                        const placeholderMap = {
                                            Contrato: "Pesquisar pelo objeto do Contrato",
                                            Anúncios: "Pesquisar pelo objeto do Anúncio",
                                            Entidades: "Pesquisar pelo nome da Entidade",
                                            "Modificações contratuais": "Pesquisar pela modificação contratual",
                                            "Bens móveis": "Pesquisar pelo bem móvel",
                                            "Não Celebrações de contrato": "Pesquisar pela não celebração",
                                            Impugnação: "Pesquisar pela impugnação",
                                        };

                                        dropdownBtn?.addEventListener('click', () => {
                                            const expanded = dropdownBtn.getAttribute("aria-expanded") === "true";
                                            dropdownBtn.setAttribute("aria-expanded", String(!expanded));
                                            dropdownMenu.style.display = expanded ? "none" : "block";
                                        });

                                        document.addEventListener('click', e => {
                                            if (!dropdownBtn.contains(e.target) && !dropdownMenu.contains(e.target)) {
                                                dropdownBtn.setAttribute("aria-expanded", "false");
                                                dropdownMenu.style.display = "none";
                                            }
                                        });

                                        qsa('.dropdown-item').forEach(item =>
                                            item.addEventListener('click', e => {
                                                const val = e.currentTarget.dataset.value;
                                                selectedContract.textContent = val;
                                                searchInput.placeholder = placeholderMap[val] || '';
                                                dropdownBtn.setAttribute("aria-expanded", "false");
                                                dropdownMenu.style.display = "none";
                                            })
                                        );

                                        // ========== Popup de Download ==========
                                        const openBtn = qs('#openPopupBtn'), closeBtn = qs('#closeBtn'), overlay = qs('#overlay');
                                        const verifyBtn = qs('#verifyCodeBtn');
                                        const step1 = qs('#downloadStep1'), step2 = qs('#downloadStep2'), step3 = qs('#downloadStep3');
                                        const inputs = qsa('.verification-input');
                                        let code = '', email = '';

                                        const showStep = step => [step1, step2, step3].forEach(s => s.classList.toggle('active', s === step));
                                        const genCode = () => (code = Math.floor(100 + Math.random() * 900).toString());
                                        const sendCode = (email, code) => {
                                            console.log(`Enviando código ${code} para ${email}`);
                                            return new Promise(res => setTimeout(() => res(true), 1000));
                                        };

                                        openBtn?.addEventListener('click', () => {
                                            overlay.style.display = 'flex';
                                            document.body.style.overflow = 'hidden';
                                        });

                                        const closePopup = () => {
                                            overlay.style.display = 'none';
                                            document.body.style.overflow = 'auto';
                                            showStep(step1);
                                            form.reset();
                                        };

                                        closeBtn?.addEventListener('click', closePopup);
                                        overlay?.addEventListener('click', e => e.target === overlay && closePopup());

                                        form?.addEventListener('submit', e => {
                                            e.preventDefault();
                                            email = qs('#email').value;
                                            sendCode(email, genCode()).then(() => {
                                                showStep(step2);
                                                inputs[0]?.focus();
                                            });
                                        });

                                        // Referências aos elementos
                                        const checkboxes = [
                                            document.getElementById('special-measures'),
                                            document.getElementById('include-mec')
                                        ];
                                        const measureTypeSelect = document.getElementById('measure-type');
                                        // Função para atualizar o estado do dropdown
                                        const updateDropdownState = () => {
                                            measureTypeSelect.disabled = !checkboxes.some(cb => cb.checked);
                                        };
                                        // Adicionar evento a todos os checkboxes
                                        checkboxes.forEach(cb => cb.addEventListener('change', updateDropdownState));
                                        // Estado inicial
                                        updateDropdownState();

                                        // ========== Listar os Conselhos ==========
                                        // Referências aos elementos
                                        const paisSelect = document.getElementById('pais-select');
                                        const distritoSelect = document.getElementById('distrito-select');
                                        const concelhoSelect = document.getElementById('concelho-select');
                                        const distritosConcelhos = {
                                            aveiro: ["Águeda", "Albergaria-a-Velha", "Anadia", "Arouca", "Aveiro", "Castelo de Paiva", "Espinho", "Estarreja", "Ílhavo", "Mealhada", "Murtosa", "Oliveira de Azeméis", "Oliveira do Bairro", "Ovar", "Santa Maria da Feira", "São João da Madeira", "Sever do Vouga", "Vagos", "Vale de Cambra"],
                                            beja: ["Aljustrel", "Almodôvar", "Alvito", "Barrancos", "Beja", "Castro Verde", "Cuba", "Ferreira do Alentejo", "Mértola", "Moura", "Odemira", "Ourique", "Serpa", "Vidigueira"],
                                            braga: ["Amares", "Barcelos", "Braga", "Cabeceiras de Basto", "Celorico de Basto", "Esposende", "Fafe", "Guimarães", "Póvoa de Lanhoso", "Terras de Bouro", "Vieira do Minho", "Vila Nova de Famalicão", "Vila Verde", "Vizela"],
                                            braganca: ["Alfândega da Fé", "Bragança", "Carrazeda de Ansiães", "Freixo de Espada à Cinta", "Macedo de Cavaleiros", "Miranda do Douro", "Mirandela", "Mogadouro", "Torre de Moncorvo", "Vila Flor", "Vimioso", "Vinhais"],
                                            castelo_branco: ["Belmonte", "Castelo Branco", "Covilhã", "Fundão", "Idanha-a-Nova", "Oleiros", "Penamacor", "Proença-a-Nova", "Sertã", "Vila de Rei", "Vila Velha de Ródão"],
                                            coimbra: ["Arganil", "Cantanhede", "Coimbra", "Condeixa-a-Nova", "Figueira da Foz", "Góis", "Lousã", "Mira", "Miranda do Corvo", "Montemor-o-Velho", "Oliveira do Hospital", "Pampilhosa da Serra", "Penacova", "Penela", "Soure", "Tábua", "Vila Nova de Poiares"],
                                            evora: ["Alandroal", "Arraiolos", "Borba", "Estremoz", "Évora", "Montemor-o-Novo", "Mora", "Mourão", "Portel", "Redondo", "Reguengos de Monsaraz", "Vendas Novas", "Viana do Alentejo", "Vila Viçosa"],
                                            faro: ["Albufeira", "Alcoutim", "Aljezur", "Castro Marim", "Faro", "Lagoa", "Lagos", "Loulé", "Monchique", "Olhão", "Portimão", "São Brás de Alportel", "Silves", "Tavira", "Vila do Bispo", "Vila Real de Santo António"],
                                            guarda: ["Aguiar da Beira", "Almeida", "Celorico da Beira", "Figueira de Castelo Rodrigo", "Fornos de Algodres", "Gouveia", "Guarda", "Manteigas", "Mêda", "Pinhel", "Sabugal", "Seia", "Trancoso", "Vila Nova de Foz Côa"],
                                            leiria: ["Alcobaça", "Alvaiázere", "Ansião", "Batalha", "Bombarral", "Caldas da Rainha", "Castanheira de Pêra", "Figueiró dos Vinhos", "Leiria", "Marinha Grande", "Nazaré", "Óbidos", "Pedrógão Grande", "Peniche", "Pombal", "Porto de Mós"],
                                            lisboa: ["Alenquer", "Amadora", "Arruda dos Vinhos", "Azambuja", "Cadaval", "Cascais", "Lisboa", "Loures", "Lourinhã", "Mafra", "Odivelas", "Oeiras", "Sintra", "Sobral de Monte Agraço", "Torres Vedras", "Vila Franca de Xira"],
                                            portalegre: ["Alter do Chão", "Arronches", "Avis", "Campo Maior", "Castelo de Vide", "Crato", "Elvas", "Fronteira", "Gavião", "Marvão", "Monforte", "Nisa", "Ponte de Sor", "Portalegre", "Sousel"],
                                            porto: ["Amarante", "Baião", "Felgueiras", "Gondomar", "Lousada", "Maia", "Marco de Canaveses", "Matosinhos", "Paços de Ferreira", "Paredes", "Penafiel", "Porto", "Póvoa de Varzim", "Santo Tirso", "São João da Madeira", "Trofa", "Valongo", "Vila do Conde", "Vila Nova de Gaia"],
                                            santarem: ["Abrantes", "Alcanena", "Almeirim", "Alpiarça", "Benavente", "Cartaxo", "Chamusca", "Constância", "Coruche", "Entroncamento", "Ferreira do Zêzere", "Golegã", "Mação", "Ourém", "Rio Maior", "Salvaterra de Magos", "Santarém", "Sardoal", "Tomar", "Torres Novas", "Vila Nova da Barquinha"],
                                            setubal: ["Alcácer do Sal", "Almada", "Barreiro", "Grândola", "Moita", "Montijo", "Palmela", "Santiago do Cacém", "Seixal", "Sesimbra", "Setúbal", "Sines"],
                                            viana_do_castelo: ["Arcos de Valdevez", "Caminha", "Melgaço", "Monção", "Paredes de Coura", "Ponte da Barca", "Ponte de Lima", "Valença", "Viana do Castelo", "Vila Nova de Cerveira"],
                                            vila_real: ["Alijó", "Boticas", "Chaves", "Mesão Frio", "Mondim de Basto", "Montalegre", "Murça", "Peso da Régua", "Ribeira de Pena", "Sabrosa", "Santa Marta de Penaguião", "Valpaços", "Vila Pouca de Aguiar", "Vila Real"],
                                            viseu: ["Armamar", "Carregal do Sal", "Castro Daire", "Cinfães", "Lamego", "Mangualde", "Moimenta da Beira", "Mortágua", "Nelas", "Oliveira de Frades", "Penalva do Castelo", "Penedono", "Resende", "Santa Comba Dão", "São João da Pesqueira", "São Pedro do Sul", "Sátão", "Sernancelhe", "Tabuaço", "Tarouca", "Tondela", "Vila Nova de Paiva", "Viseu", "Vouzela"]
                                        };
                                        // Utilitário para ativar/desativar <select>
                                        const setDisabled = (select, disabled) => {
                                            select.disabled = disabled;
                                            if (disabled) select.value = "";
                                        };

                                        // Atualiza o estado dos selects de distrito e concelho com base no país
                                        const atualizarDistritos = () => {
                                            const isPortugal = paisSelect.value === "portugal";
                                            setDisabled(distritoSelect, !isPortugal);
                                            setDisabled(concelhoSelect, true);
                                            concelhoSelect.innerHTML = '<option value="">Selecione um concelho</option>';
                                        };

                                        // Preenche os concelhos com base no distrito selecionado
                                        const preencherConcelhos = () => {
                                            const concelhos = distritosConcelhos[distritoSelect.value] || [];
                                            concelhoSelect.innerHTML = '<option value="">Selecione um concelho</option>';
                                            setDisabled(concelhoSelect, concelhos.length === 0);

                                            concelhos.forEach(nome => {
                                                const option = new Option(nome, nome.toLowerCase().replace(/\s+/g, '_'));
                                                concelhoSelect.appendChild(option);
                                            });
                                        };

                                        // Mostrar resultados ao clicar no botão de pesquisa
                                        const searchForm = document.querySelector('form[action="/base_gov"]');
                                        searchForm.addEventListener('submit', function (e) {
                                            e.preventDefault(); // Impede o reload/subida da página
                                            const resultsTable = document.querySelector('#results-table');
                                            resultsTable.style.display = 'block';
                                            resultsTable.scrollIntoView({ behavior: 'smooth' });
                                            // Aqui você pode adicionar sua lógica de pesquisa AJAX, se desejar
                                        });

                                        // Listeners de selects
                                        paisSelect.addEventListener('change', atualizarDistritos);
                                        distritoSelect.addEventListener('change', preencherConcelhos);

                                        // Tooltip hover delay logic
                                        qsa('.info-hover').forEach(label => {
                                            let timer;
                                            label.addEventListener('mouseenter', () => {
                                                timer = setTimeout(() => label.classList.add('show-tooltip'), 135);
                                            });
                                            label.addEventListener('mouseleave', () => {
                                                clearTimeout(timer);
                                                label.classList.remove('show-tooltip');
                                            });
                                            label.addEventListener('focusin', () => {
                                                label.classList.add('show-tooltip');
                                            });
                                            label.addEventListener('focusout', () => {
                                                label.classList.remove('show-tooltip');
                                            });
                                        });
                                    });
                                </script>

</body>

</html>